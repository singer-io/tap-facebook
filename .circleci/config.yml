version: 2.1

workflows:
  commit:
    jobs:
      - ensure_env:
          context: circleci-user
      - run_pylint:
          context: circleci-user
          requires:
            - ensure_env
      - run_unit_tests:
          context: circleci-user
          requires:
            - ensure_env

executors:
  docker-executor:
    docker:
      - image: 218546966473.dkr.ecr.us-east-1.amazonaws.com/circle-ci:tap-tester-v4

commands:
  source-tap-venv:
    steps:
      - run:
          command: |
            source /usr/local/share/virtualenvs/tap-facebook/bin/activate

jobs:
  ensure_env:
    executor: docker-executor
    steps:
      - checkout
      - run:
          name: 'Setup Virtual Env'
          command: |
            python3 -m venv /usr/local/share/virtualenvs/tap-facebook
            source /usr/local/share/virtualenvs/tap-facebook/bin/activate
            pip install -U pip setuptools
            pip install .[dev]
      - persist_to_workspace:
          root: /usr/local/share/virtualenvs
          paths:
            - tap-facebook
  run_pylint:
    executor: docker-executor
    steps:
      - checkout
      - attach_workspace:
          at: /usr/local/share/virtualenvs
      - run:
          name: 'Run pylint'
          command: |
            source /usr/local/share/virtualenvs/tap-facebook/bin/activate
            pylint tap_facebook -d C,R,W
  run_unit_tests:
    executor: docker-executor
    steps:
      - checkout
      - attach_workspace:
          at: /usr/local/share/virtualenvs
      - run:
          name: 'Run Unit Tests'
          command: |
            source /usr/local/share/virtualenvs/tap-facebook/bin/activate
            nosetest tests/unittests
  run_integration_tests:
    executor: docker-executor
    parallelism: 2
    steps:
      - checkout
      - attach_workspace:
          at: /usr/local/share/virtualenvs
      - run:
          name: 'Run Unit Tests'
          command: |
            aws s3 cp s3://com-stitchdata-dev-deployment-assets/environments/tap-tester/tap_tester_sandbox dev_env.sh
            source dev_env.sh
            source /usr/local/share/virtualenvs/tap-tester/bin/activate

            circleci tests glob "tests/*.py" | circleci tests split > ./tests-to-run
            if [ -s ./tests-to-run ]; then
              for test_file in $(cat ./tests-to-run)
              do
                run-test --tap=tap-facebook \
                         --target=target-stitch \
                         --orchestrator=stitch-orchestrator \
                         --email=harrison+sandboxtest@stitchdata.com \
                         --password=$SANDBOX_PASSWORD \
                         --client-id=50 \
                         $test_file
              done
            fi


orbs:
  slack: circleci/slack@3.4.2
