version: 2.1

workflows:
  commit:
    jobs:
      - ensure_env:
          context: circleci-user
      - run_pylint:
          context: circleci-user

executors:
  docker-executor:
    docker:
      - image: 218546966473.dkr.ecr.us-east-1.amazonaws.com/circle-ci:tap-tester-v4

commands:
  source-tap-venv:
    steps:
      - run:
          command: |
            source /usr/local/share/virtualenvs/tap-facebook/bin/activate

jobs:
  ensure_env:
    executor: docker-executor
    steps:
      - checkout
      - run:
          name: 'Setup Virtual Env'
          command: |
            python3 -m venv /usr/local/share/virtualenvs/tap-facebook
            source /usr/local/share/virtualenvs/tap-facebook/bin/activate
            pip install -U pip setuptools
            pip install .[dev]
      - persist_to_workspace:
          root: /usr/local/share/virtualenvs
          paths:
            - tap-facebook
  run_pylint:
    executor: docker-executor
    steps:
      - attach_workspace:
          at: /usr/local/share/virtualenvs
      - source-tap-venv
      - run: pylint tap_facebook -d C,R,W

orbs:
  slack: circleci/slack@3.4.2
