version: 2.1

workflows:
  commit:
    jobs:
      - ensure_env:
          context: circleci-user
      - run_pylint:
          context: circleci-user
          requires:
            - ensure_env
      - run_unit_tests:
          context: circleci-user
          requires:
            - ensure_env

executors:
  docker-executor:
    docker:
      - image: 218546966473.dkr.ecr.us-east-1.amazonaws.com/circle-ci:tap-tester-v4

commands:
  source-tap-venv:
    steps:
      - run:
          command: |
            source /usr/local/share/virtualenvs/tap-facebook/bin/activate

jobs:
  ensure_env:
    executor: docker-executor
    steps:
      - checkout
      - run:
          name: 'Setup Virtual Env'
          command: |
            python3 -m venv /usr/local/share/virtualenvs/tap-facebook
            source /usr/local/share/virtualenvs/tap-facebook/bin/activate
            pip install -U pip setuptools
            pip install .[dev]
      - persist_to_workspace:
          root: /usr/local/share/virtualenvs
          paths:
            - tap-facebook
  run_pylint:
    executor: docker-executor
    steps:
      - checkout
      - attach_workspace:
          at: /usr/local/share/virtualenvs
      - run:
          name: 'Run pylint'
          command: |
            source /usr/local/share/virtualenvs/tap-facebook/bin/activate
            pylint tap_facebook -d C,R,W
  run_unit_tests:
    executor: docker-executor
    parallelism: 4
    steps:
      - checkout
      - attach_workspace:
          at: /usr/local/share/virtualenvs
      - run:
          name: 'Run Unit Tests'
          command: |
            source /usr/local/share/virtualenvs/tap-facebook/bin/activate
            circleci tests glob "tests/unittests/*.py" | circleci tests split > ./tests-to-run
            if [ -s ./tests-to-run ]; then
              nosetests $(cat tests-to-run)
            fi


orbs:
  slack: circleci/slack@3.4.2
